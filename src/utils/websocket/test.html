<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket 连接测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .log-area {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        .log-info { color: #0052d9; }
        .log-success { color: #00a870; }
        .log-error { color: #e34d59; }
        .log-warning { color: #ed7b2f; }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.connected {
            background: #e6f7ef;
            border: 1px solid #00a870;
            color: #00a870;
        }
        .status.disconnected {
            background: #fff1f0;
            border: 1px solid #e34d59;
            color: #e34d59;
        }
    </style>
</head>
<body>
    <h1>WebSocket 系统更新检查 - 测试工具</h1>

    <div id="status" class="status disconnected">
        状态: 未连接
    </div>

    <div class="controls">
        <button onclick="connect()">连接 WebSocket</button>
        <button onclick="disconnect()">断开连接</button>
        <button onclick="sendCheck()">发送检查请求</button>
        <button onclick="clearLogs()">清空日志</button>
    </div>

    <h3>连接日志:</h3>
    <div id="log" class="log-area"></div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>

    <script>
        let stompClient = null;
        let connected = false;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(isConnected) {
            connected = isConnected;
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
            statusDiv.textContent = `状态: ${isConnected ? '已连接 ✓' : '未连接 ✗'}`;
        }

        function connect() {
            if (connected) {
                log('已经连接，无需重复连接', 'warning');
                return;
            }

            log('正在连接 WebSocket...', 'info');

            // 创建 STOMP 客户端
            stompClient = new StompJs.Client({
                webSocketFactory: () => new SockJS('http://localhost:80/ws'),

                connectHeaders: {
                    // 如果需要认证，在这里添加 token
                    // Authorization: 'Bearer YOUR_TOKEN'
                },

                debug: (str) => {
                    log(`[STOMP] ${str}`, 'info');
                },

                reconnectDelay: 5000,
                heartbeatIncoming: 10000,
                heartbeatOutgoing: 10000,

                onConnect: (frame) => {
                    log('WebSocket 连接成功！', 'success');
                    updateStatus(true);

                    // 订阅系统更新主题
                    stompClient.subscribe('/user/queue/system/update', (message) => {
                        log('收到消息！', 'success');
                        try {
                            const data = JSON.parse(message.body);
                            log(`消息内容: ${JSON.stringify(data, null, 2)}`, 'success');

                            if (data.hasUpdate) {
                                log(`发现更新: ${data.announcementTitle}`, 'success');
                                log(`公告ID: ${data.announcementId}`, 'success');
                                log(`公告内容: ${data.announcementContent}`, 'success');
                            } else {
                                log('当前已是最新版本', 'success');
                            }
                        } catch (e) {
                            log(`解析消息失败: ${e.message}`, 'error');
                        }
                    });

                    log('已订阅主题: /user/queue/system/update', 'success');

                    // 自动发送一次检查请求
                    setTimeout(() => sendCheck(), 1000);
                },

                onStompError: (frame) => {
                    log(`STOMP 错误: ${frame.headers['message']}`, 'error');
                    log(`详情: ${frame.body}`, 'error');
                    updateStatus(false);
                },

                onWebSocketError: (event) => {
                    log('WebSocket 错误', 'error');
                    console.error('WebSocket error:', event);
                    updateStatus(false);
                },

                onDisconnect: () => {
                    log('WebSocket 已断开', 'warning');
                    updateStatus(false);
                }
            });

            // 激活连接
            stompClient.activate();
        }

        function disconnect() {
            if (!connected) {
                log('尚未连接', 'warning');
                return;
            }

            log('正在断开连接...', 'info');
            stompClient.deactivate();
            updateStatus(false);
        }

        function sendCheck() {
            if (!connected) {
                log('请先连接 WebSocket', 'error');
                return;
            }

            log('发送检查更新请求到 /app/system/check-update', 'info');
            stompClient.publish({
                destination: '/app/system/check-update',
                body: JSON.stringify({})
            });
            log('请求已发送，等待响应...', 'info');
        }

        function clearLogs() {
            document.getElementById('log').innerHTML = '';
            log('日志已清空', 'info');
        }

        // 页面加载完成后自动连接
        window.addEventListener('load', () => {
            log('测试工具已加载', 'info');
            log('点击"连接 WebSocket"按钮开始测试', 'info');
            log('', 'info');
            log('后端接口配置:', 'info');
            log('- 连接地址: ws://localhost:80/ws', 'info');
            log('- 订阅主题: /user/queue/system/update', 'info');
            log('- 发送地址: /app/system/check-update', 'info');
        });
    </script>
</body>
</html>
